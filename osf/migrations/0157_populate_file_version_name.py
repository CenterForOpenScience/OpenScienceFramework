# -*- coding: utf-8 -*-
# Generated by Django 1.11.15 on 2019-03-03 17:52
from __future__ import unicode_literals

import logging
from math import ceil

from django.db import migrations, connection

logger = logging.getLogger(__file__)

increment = 10000

def noop(*args, **kwargs):
    pass


# Batching adapted from strategy in website/search_migration/migrate.py
def populate_fileversion_name(state, schema):
    FileVersion = state.get_model('osf.fileversion')
    max_vid = getattr(FileVersion.includable_objects.order_by('id').last(), 'id', 0)

    sql = """
        DROP TABLE IF EXISTS fileversion_name;

        CREATE TEMPORARY TABLE fileversion_name
          (
            version_id INTEGER,
            filename TEXT
          )
          ON COMMIT DROP;

        INSERT INTO fileversion_name (version_id, filename)
        SELECT DISTINCT ON (fileversion_id) V.id, F.name
        FROM osf_basefilenode_versions, osf_fileversion V, osf_basefilenode F
        WHERE osf_basefilenode_versions.fileversion_id = V.id
        AND osf_basefilenode_versions.basefilenode_id = F.id
        AND V.id > {}
        AND V.id <= {}
        ORDER BY fileversion_id, F.created DESC;

        UPDATE osf_fileversion V
        SET name = fileversion_name.filename
        FROM fileversion_name
        WHERE fileversion_name.version_id = V.id
        AND V.id > {}
        AND V.id <= {};
    """

    total_pages = int(ceil(max_vid / float(increment)))
    page_start = 0
    page_end = 0
    page = 0
    while page_end <= (max_vid):
        page += 1
        page_end += increment
        if page <= total_pages:
            logger.info('Updating fileversion page {} / {}'.format(page_end / increment, total_pages))
        with connection.cursor() as cursor:
            cursor.execute(sql.format(
                page_start,
                page_end,
                page_start,
                page_end
            ))
        page_start = page_end

class Migration(migrations.Migration):

    dependencies = [
        ('osf', '0156_fileversion_name'),
    ]

    operations = [
        migrations.RunPython(populate_fileversion_name, noop)
    ]
